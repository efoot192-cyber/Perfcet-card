<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Perfect Wallet</title>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="manifest" href="manifest.json">
<style>
body {background: linear-gradient(135deg,#0f2027,#00545f,#000a61fd);color:#fff;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;transition:background 0.5s;}
.box {background: rgba(255,255,255,0.05);backdrop-filter:blur(10px);max-width:400px;width:100%;padding:25px;border-radius:20px;box-shadow:0 10px 35px rgba(0,0,0,0.6);transition:transform 0.3s, box-shadow 0.3s;}
.box:hover {transform:translateY(-5px); box-shadow:0 15px 40px rgba(0,0,0,0.7);}
h2,h3 {text-align:center;font-weight:600;}
.section {margin-bottom:25px;}
input,button {width:100%;padding:10px 12px;margin-top:8px;border:none;border-radius:8px;font-size:15px;outline:none;transition:all 0.3s;}
input{
  background:#101827;
  border:1px solid rgba(255,255,255,0.1);
  padding:14px;
  border-radius:12px;
}
input::placeholder {color:#ddd;}
input:focus {background: rgba(255,255,255,0.2); box-shadow:0 0 5px #0984e3;}
button{
  padding:14px;
  border-radius:12px;
  font-size:16px;
}
button:hover {background:linear-gradient(90deg,#04fff2bd,#00eeff);transform:scale(1.05);}
.danger {background:linear-gradient(90deg,#e74c3c,#d63031);}
.danger:hover {background:linear-gradient(90deg,#ff7675,#e17055);}
#msg,#msgMain,#msgForgot,#msgRegister,#msgQR,#msgRefresh {text-align:center;margin-top:6px;font-weight:bold;}
a {text-decoration:none;color:#00ff22;cursor:pointer;}
video {width:100%;border-radius:12px;margin-top:10px;}
.history {background: rgba(0,0,0,0.3);padding:12px;max-height:160px;overflow-y:auto;font-size:14px;border-radius:8px;box-shadow: inset 0 0 5px rgba(255,255,255,0.1);}
.history::-webkit-scrollbar {width:6px;}
.history::-webkit-scrollbar-thumb {background:#0004ff;border-radius:3px;}
/* Popup */
.popup-overlay{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.75);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
  animation:fadeIn .3s ease;
}

.popup-card{
  background:rgba(20,20,40,0.95);
  padding:25px;
  border-radius:18px;
  width:320px;
  text-align:center;
  box-shadow:0 0 25px rgba(0,255,255,0.3);
  animation:scaleIn .35s ease;
}

.success-icon{
  font-size:40px;
  background:linear-gradient(90deg,#00ffcc,#00aaff);
  width:70px;
  height:70px;
  line-height:70px;
  margin:auto;
  border-radius:50%;
  margin-bottom:10px;
}

.popup-info{
  text-align:right;
  margin:15px 0;
  font-size:15px;
}

.popup-card button{
  background:linear-gradient(90deg,#00c6ff,#0072ff);
}

@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}

@keyframes scaleIn{
  from{transform:scale(.7);opacity:0}
  to{transform:scale(1);opacity:1}
}
#loadingScreen h2 {
  font-size: 1.5rem;
  text-align: center;
}

#loadingBar {
  transition: width 0.3s ease;
}
.balance-box-container {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
}

.balance-box-updated {
  background: linear-gradient(135deg, #0072ff, #00c6ff);
  padding: 20px 30px;
  border-radius: 15px;
  color: #fff;
  text-align: center;
  box-shadow: 0 8px 25px rgba(0,0,0,0.5);
  min-width: 250px;
  transition: transform 0.3s, box-shadow 0.3s;
}

.balance-box-updated:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 35px rgba(0,0,0,0.6);
}

.balance-title-updated {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 10px;
}

.balance-amount-updated {
  font-size: 32px;
  font-weight: bold;
  margin-bottom: 5px;
  display: flex;
  justify-content: center;
  align-items: baseline;
  gap: 5px;
}

.balance-amount-updated .currency {
  font-size: 20px;
}

.balance-username-updated {
  font-size: 14px;
  opacity: 0.8;
}

.brand{
  text-align:center;
  margin-bottom:20px;
}

.brand img{
  width:70px;
  margin-bottom:10px;
}

.brand span{
  font-size:13px;
  color:#aaa;
}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
</head>
<body>

<!-- Login -->
<div id="loginDiv" class="box">
<div class="brand">
  <img src="logo.png">
  <h2>Perfect Wallet</h2>
  <span>Secure Digital Payments</span>
</div>
  <h3>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
  <input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
  <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <label style="display:flex;align-items:center;margin-top:10px;"><input type="checkbox" id="rememberMe"> ØªØ°ÙƒØ±Ù†ÙŠ</label>
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  <p style="text-align:center; margin-top:10px;"><a onclick="showForgot()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</a></p>
  <hr style="margin:15px 0; border-color: rgba(255,255,255,0.2)">
  <h3>ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h3>
  <button onclick="showRegister()">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
  <p id="msg"></p>
</div>

<div id="registerDiv" class="box" style="display:none">
  <h3>ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h3>
  <input id="regUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
  <input id="regPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>
  <p id="msgRegister"></p>
  <button onclick="backToLogin()" style="margin-top:10px; background:#e67e22;">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="forgotDiv" class="box" style="display:none">
  <h3>ğŸ”‘ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</h3>
  <input id="forgotUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
  <input id="forgotPin" type="number" placeholder="Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù† PIN">
  <input id="newPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
  <button onclick="resetPassword()">ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
  <p id="msgForgot"></p>
  <button onclick="backToLogin()" style="margin-top:10px; background:#e67e22;">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- Main -->
<div id="mainDiv" class="box" style="display:none">
  <div style="text-align:center; margin-bottom:15px;">
    <img src="cart.png" style="width:100%; max-width:400px;">
  </div>
  <div class="section">
    <h3></h3>
    <div class="balance-card">
      <div class="chip"></div>
      <div class="balance-box-container">
  <div class="balance-box-updated">
    <div class="balance-title-updated">Wallet Balance: </div>
    <div class="balance-amount-updated">
      <span class="currency"> â‚¬ </span>
      <span id="balance">0</span>
    </div>
    <div class="balance-username-updated" id="userNameDisplay">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
  </div>
</div>

    <button onclick="refreshBalance()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯</button>
    <p id="msgRefresh"></p>
  </div>

  <div class="section section-card">
    <h3>ğŸ”‘ Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</h3>
    <input id="codeInput" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø´Ø­Ù†">
    <button onclick="recharge()">Ø´Ø­Ù†</button>
    <p id="msgMain"></p>
  </div>

  <div class="section section-card">
    <h3>ğŸ’³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h3>
    <div class="card-display">
      <div class="chip"></div>
      <h3 id="cardNumber">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</h3>
      <div class="amount" id="cvv">---</div>
      <div class="user-name">Card Holder: <span id="userNameCard">---</span></div>
    </div>
    <button onclick="createCard()">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø©</button>
  </div>

  <div class="section section-card">
    <h3>ğŸ” ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯</h3>
    <input id="toUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <input id="transferAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
    <button onclick="transferMoney()">ØªØ­ÙˆÙŠÙ„</button>
  </div>
  <div class="section section-card">
    <h3>ğŸ“±  Perfect Pay </h3>
    <button onclick="startQRPay()">Ø¯ÙØ¹  </button>
    <video id="video" style="display:none"></video>
    <p id="msgQR"></p>
  </div>

  <div class="section">
    <h3>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
    <div id="history" class="history"></div>
  </div>
  
  <div id="successPay" class="popup-overlay">
  <div class="popup-card">
    <div class="success-icon">âœ”</div>
    <h2>ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­</h2>
  </div>
</div>
  
  <!-- Transfer Success Popup -->
<div id="transferPopup" class="popup-overlay">
  <div class="popup-card">
    <div class="success-icon">âœ”</div>
    <h2>ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­</h2>

    <div class="popup-info">
      <p><strong>Ø§Ù„Ù…Ø±Ø³Ù„:</strong> <span id="popupFrom"></span></p>
      <p><strong>Ø§Ù„Ù…Ø³ØªÙ„Ù…:</strong> <span id="popupTo"></span></p>
      <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> <span id="popupAmount"></span>$</p>
      <p><strong>Ø§Ù„ØªÙˆÙ‚ÙŠØª:</strong> <span id="popupTime"></span></p>
    </div>

    <button onclick="closePopup()">Ø­Ø³Ù†Ø§Ù‹</button>
  </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loadingScreen" style="
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100vh; /* Ø§Ø³ØªØ®Ø¯Ù… vh Ù„Ù…Ù„Ø¡ ÙƒØ§Ù…Ù„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¬Ù‡Ø§Ø² */
    background:#0f2027;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    z-index:9999;
    overflow:hidden;
">
  <h2 style="color:#fff;margin-bottom:20px;">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
  <div style="width:70%;height:20px;background:rgba(255,255,255,0.1);border-radius:10px;overflow:hidden;">
    <div id="loadingBar" style="width:0%;height:100%;background:#00eeff;"></div>
  </div>
</div>

<!-- Apple Pay Style -->
<div id="payPopup" class="popup-overlay">
  <div class="popup-card">
    <div class="success-icon">ğŸ§¾</div>

    <h2 id="payStore">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</h2>

    <div style="font-size:35px;margin:15px 0;">
      $<span id="payAmount">0</span>
    </div>

    <p>Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Perfect Pay</p>

    <button onclick="confirmPayment()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹</button>
    <button onclick="cancelPayment()" class="danger" style="margin-top:10px">
      Ø¥Ù„ØºØ§Ø¡
    </button>
  </div>
</div>

  <div class="section">
    <button class="danger" onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<!-- âœ… FOOTER Ù‡Ù†Ø§ -->
<footer class="footer">
  Â© 2026 Perfect Bank â€” Secure Digital Payments
</footer>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC2euiKINjcx9Ay8qapBMCDbh9QFVzsVss",
  authDomain: "abdo-eea3d.firebaseapp.com",
  databaseURL: "https://abdo-eea3d-default-rtdb.firebaseio.com",
  projectId: "abdo-eea3d",
  storageBucket: "abdo-eea3d.firebasestorage.app",
  messagingSenderId: "516114812388",
  appId: "1:516114812388:web:a16dc18f4abe3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
let users = {};
let rechargeCodes = { "A80X":8,"B25Y":2,"C500Z":5,"C0050Z":5,"D100Q":1,"E200W":2,"E2000W":2,"VIP300":3,"VIP350":30,"F150R":10,"G75M":75,"H60N":60,"I90K":90,"J120L":1,"K180P":10,"L220S":220,"M400T":400,"N600U":600,"O800V":8,"P1000X":1,"Q50A":5,"R30B":3,"S70C":7,"T250D":2,"U450E":4,"V550F":5,"W750G":7,"W750G11":7,"X900H":9,"VIP500":50};

function saveUsers(){ db.ref('users').set(users); }
function loadUsers(callback){ db.ref('users').once('value').then(snap=>{ users=snap.val()||{}; callback(); }); }

// ---------------- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ----------------
function login(){
  let u=document.getElementById('username').value.trim();
  let p=document.getElementById('password').value.trim();
  const msg=document.getElementById('msg');
  const rememberMe=document.getElementById('rememberMe').checked;
  loadUsers(()=>{
    if(!users[u] || users[u].password!==p){ msg.innerText="âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©"; return; }
    currentUser=u;
    if(rememberMe) localStorage.setItem('rememberedUser',u);
    document.getElementById('loginDiv').style.display="none";
    document.getElementById('mainDiv').style.display="block";
    initUserUI();
  });
}

let pendingPayment = null;

// Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
window.addEventListener('load', function(){
  let bar = document.getElementById('loadingBar');
  let screen = document.getElementById('loadingScreen');
  let width = 0;
  let interval = setInterval(()=>{
    width += Math.random()*10; // Ø³Ø±Ø¹Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
    if(width>=100) width=100;
    bar.style.width = width + '%';
    if(width>=100){
      clearInterval(interval);
      setTimeout(()=>{
        screen.style.display='none';
      },500); // Ø¨Ø¹Ø¯ Ù†ØµÙ Ø«Ø§Ù†ÙŠØ© ÙŠØ®ØªÙÙŠ
    }
  },200);
});

// ---------------- Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« ----------------
window.onload = function(){
  const remembered = localStorage.getItem('rememberedUser');
  if(remembered){
    currentUser = remembered;
    loadUsers(()=>{
      if(users[currentUser]){
        document.getElementById('loginDiv').style.display="none";
        document.getElementById('mainDiv').style.display="block";
        initUserUI();
      } else {
        localStorage.removeItem('rememberedUser');
      }
    });
  }
}

// ---------------- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ----------------
function showRegister(){ document.getElementById('loginDiv').style.display='none'; document.getElementById('registerDiv').style.display='block'; }
function register(){
  let u=document.getElementById('regUsername').value.trim();
  let p=document.getElementById('regPassword').value.trim();
  const msg=document.getElementById('msgRegister');
  if(!u||!p){ msg.innerText="âŒ Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"; return; }
  loadUsers(()=>{
    if(users[u]){ msg.innerText="âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯"; return; }
    let pin=Math.floor(1000+Math.random()*9000);
    users[u]={password:p,balance:0,history:[],cardNumber:null,cvv:null,pin:pin};
    saveUsers();
    msg.innerText=`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­. Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ: ${pin}`;
  });
}

function backToLogin(){ document.getElementById('registerDiv').style.display='none'; document.getElementById('forgotDiv').style.display='none'; document.getElementById('loginDiv').style.display='block'; }
function showForgot(){ document.getElementById('loginDiv').style.display='none'; document.getElementById('forgotDiv').style.display='block'; }
function resetPassword(){
  let u=document.getElementById('forgotUsername').value.trim();
  let pin=document.getElementById('forgotPin').value.trim();
  let newPass=document.getElementById('newPassword').value.trim();
  let msg=document.getElementById('msgForgot');
  if(!u||!pin||!newPass){ msg.innerText="âŒ Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"; return; }
  loadUsers(()=>{
    if(!users[u]){ msg.innerText="âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"; return; }
    if(users[u].pin!=pin){ msg.innerText="âŒ Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù† ØºÙŠØ± ØµØ­ÙŠØ­"; return; }
    users[u].password=newPass;
    saveUsers();
    msg.innerText="âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¨Ù†Ø¬Ø§Ø­";
  });
}

function showLogin(){
  document.getElementById('landingPage').style.display = 'none';
  document.getElementById('loginDiv').style.display = 'block';
}

function showRegister(){
  document.getElementById('landingPage').style.display = 'none';
  document.getElementById('registerDiv').style.display = 'block';
}

function initUserUI(){
  let user=users[currentUser];
  user.balance=user.balance||0;
  user.history=user.history||[];
  user.cardNumber=user.cardNumber||null;
  user.cvv=user.cvv||null;
  document.getElementById("balance").innerText=user.balance;
  document.getElementById("userNameDisplay").innerText=currentUser;
  document.getElementById("cardNumber").innerText=user.cardNumber||"ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
  document.getElementById("cvv").innerText=user.cvv||"---";
  document.getElementById("userNameCard").innerText=currentUser;
  showHistory();
}

function recharge(){
  let code = document.getElementById('codeInput').value.trim();
  let msg = document.getElementById('msgMain');
  if(!code){ msg.innerText="âŒ Ø§Ù…Ù„Ø£ Ø§Ù„ÙƒÙˆØ¯"; return; }

  db.ref(`rechargeCodes/${code}`).once('value').then(snap=>{
    if(!snap.exists()){
      msg.innerText="âŒ ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­";
      return;
    }

    let data = snap.val();
    if(data.uses <= 0){
      msg.innerText="âŒ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„";
      return;
    }

    // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    let user = users[currentUser];
    user.balance = (user.balance || 0) + data.amount;
    user.history.push(`ğŸ’° Ø´Ø­Ù† +${data.amount}$ (ÙƒÙˆØ¯ ${code})`);
    document.getElementById("balance").innerText = user.balance;
    showHistory();

    // Ù†Ù‚Øµ Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª
    db.ref(`rechargeCodes/${code}/uses`).set(data.uses - 1);

    msg.innerText=`âœ… ØªÙ… Ø´Ø­Ù† ${data.amount}$`;
    saveUsers();
  });
}

function createCard(){
  let user=users[currentUser];
  if(user.cardNumber){ alert("âŒ Ù„Ø¯ÙŠÙƒ Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø§Ù„ÙØ¹Ù„"); return; }
  user.cardNumber="4000-"+Math.floor(1000+Math.random()*9000)+"-"+Math.floor(1000+Math.random()*9000)+"-"+Math.floor(1000+Math.random()*9000);
  user.cvv=Math.floor(100+Math.random()*900);
  user.history.push("ğŸ’³ Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø©");
  document.getElementById("cardNumber").innerText=user.cardNumber;
  document.getElementById("cvv").innerText=user.cvv;
  document.getElementById("userNameCard").innerText=currentUser;
  saveUsers();
  showHistory();
}

function transferMoney(){
  let toUser=document.getElementById('toUser').value.trim();
  let amount=parseInt(document.getElementById('transferAmount').value,10);
  let user=users[currentUser];
  if(!users[toUser]) return alert("âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  if(toUser===currentUser) return alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù†ÙØ³Ùƒ");
  if(!amount||amount<=0) return alert("âŒ Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­");
  if(amount>10000) return alert("âŒ Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§");
  if(user.balance<amount) return alert("âŒ Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");
  user.balance-=amount;
  users[toUser].balance+=amount;
  user.history.push(`ğŸ” ØªØ­ÙˆÙŠÙ„ -${amount}$ Ø¥Ù„Ù‰ ${toUser}`);
  users[toUser].history=users[toUser].history||[];
  users[toUser].history.push(`ğŸ” ØªØ­ÙˆÙŠÙ„ +${amount}$ Ù…Ù† ${currentUser}`);
  document.getElementById("balance").innerText=user.balance;
  showTransferPopup(currentUser,toUser,amount);
  saveUsers();
  showHistory();
}

function showTransferPopup(from,to,amount){
  const now = new Date();
  const time =
    now.toLocaleDateString() + " - " +
    now.toLocaleTimeString();

  document.getElementById("popupFrom").innerText = from;
  document.getElementById("popupTo").innerText = to;
  document.getElementById("popupAmount").innerText = amount;
  document.getElementById("popupTime").innerText = time;

  document.getElementById("transferPopup").style.display="flex";
}

function closePopup(){
  document.getElementById("transferPopup").style.display="none";
}

function showHistory(){
  let box=document.getElementById("history");
  if(!box) return;
  let user=users[currentUser];
  box.innerHTML="";
  user.history.forEach(h=>{
    let p=document.createElement("p");
    p.innerText=h;
    box.appendChild(p);
  });
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
function refreshBalance(){
  let msg=document.getElementById("msgRefresh");
  msg.innerText="â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...";
  loadUsers(()=>{
    if(!users[currentUser]){ msg.innerText="âŒ Ø­Ø¯Ø« Ø®Ø·Ø£"; return; }
    let u=users[currentUser];
    document.getElementById("balance").innerText=u.balance||0;
    document.getElementById("cardNumber").innerText=u.cardNumber||"ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
    document.getElementById("cvv").innerText=u.cvv||"---";
    showHistory();
    msg.innerText="âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯";
    setTimeout(()=>msg.innerText="",1500);
  });
}

function logout(){ 
  currentUser=null; 
  localStorage.removeItem('rememberedUser');
  location.reload(); 
}

// ---------------- QR Pay ----------------
let video = document.getElementById('video');
let scanning = false;
function startQRPay(){
  if(scanning) return;
  scanning = true;
  video.style.display='block';
  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
    .then(stream=>{video.srcObject=stream; video.setAttribute("playsinline",true); video.play(); tick();})
    .catch(err=>{document.getElementById('msgQR').innerText="âŒ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§"; scanning=false;});
}

function tick(){
  if(video.readyState===video.HAVE_ENOUGH_DATA){
    let canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    let ctx = canvas.getContext("2d");
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    let imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    let code = jsQR(imageData.data, canvas.width, canvas.height);
    if(code){ processQRPayment(code.data); stopVideo(); return; }
  }
  if(scanning) requestAnimationFrame(tick);
}

function stopVideo(){ scanning=false; video.srcObject.getTracks().forEach(track=>track.stop()); video.style.display='none'; }

function processQRPayment(data){
  let msg=document.getElementById('msgQR');
  let payment;

  try{
    payment=JSON.parse(data);
  }catch(e){
    msg.innerText="âŒ QR ØºÙŠØ± ØµØ§Ù„Ø­";
    return;
  }

  if(!users[payment.storeId]){
    msg.innerText="âŒ Ø§Ù„Ù…ØªØ¬Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
    return;
  }

  pendingPayment = payment;

  document.getElementById("payStore").innerText =
    payment.storeName || payment.storeId;

  document.getElementById("payAmount").innerText =
    payment.amount;

  document.getElementById("payPopup").style.display="flex";
}

function confirmPayment(){

  if(!pendingPayment) return;

  let fromUser = users[currentUser];
  let toUser = pendingPayment.storeId;
  let amount = pendingPayment.amount;

  if(fromUser.balance < amount){
    toast("âŒ Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");
    cancelPayment();
    return;
  }

  // Ø®ØµÙ…
  fromUser.balance -= amount;
  users[toUser].balance += amount;

  let time = new Date().toLocaleString();

  fromUser.history.push(`ğŸ“± Ø¯ÙØ¹ ${amount}$ Ø¥Ù„Ù‰ ${toUser} | ${time}`);
  users[toUser].history.push(`ğŸ“± Ø§Ø³ØªÙ„Ø§Ù… ${amount}$ Ù…Ù† ${currentUser} | ${time}`);

  saveUsers();
  showHistory();

  document.getElementById("balance").innerText = fromUser.balance;

  cancelPayment();

  showSuccessAnimation();
}

function cancelPayment(){
  pendingPayment=null;
  document.getElementById("payPopup").style.display="none";
}

function showSuccessAnimation(){
  let el=document.getElementById("successPay");
  el.style.display="flex";

  setTimeout(()=>{
    el.style.display="none";
  },2000);
}
</script>
</body>
    </html>





